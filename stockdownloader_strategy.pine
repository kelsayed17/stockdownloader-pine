// This Pine Script source code is subject to the terms of the Mozilla Public License 2.0
// https://mozilla.org/MPL/2.0/
//
// Stock Downloader Strategy
//
// Core trading strategy with Call (Long) and Put (Short) entry/exit signals.
// Includes ATR-based risk management, trailing stops, trend filters,
// volume confirmation, trade cooldown, and weighted confluence scoring.
//
// Strategies:
//   1. SMA Crossover (50/200)
//   2. SMA Crossover (20/50)
//   3. RSI (14, 30/70)
//   4. RSI (14, 25/75)
//   5. MACD (12/26/9)
//   6. BB + RSI Mean Reversion
//   7. Momentum Confluence
//   8. Breakout
//   9. Multi-Indicator Confluence (weighted)
//
// Use with companion scripts:
//   - stockdownloader_overlay.pine   (visual indicators)
//   - stockdownloader_dashboard.pine (confluence scanner)

//@version=6
strategy("StockDownloader Strategy", overlay=true,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=10,
     initial_capital=100000,
     commission_value=0.05,
     slippage=1,
     process_orders_on_close=false,
     pyramiding=0,
     calc_on_every_tick=true,
     max_labels_count=500)

// ---------------------------------------------------------------------------
// INPUTS
// ---------------------------------------------------------------------------

string STRAT_GROUP    = "Strategy Selection"
string SMA_GROUP      = "SMA Crossover Settings"
string RSI_GROUP      = "RSI Settings"
string MACD_GROUP     = "MACD Settings"
string BB_RSI_GROUP   = "BB + RSI Mean Reversion Settings"
string MOM_GROUP      = "Momentum Confluence Settings"
string BRK_GROUP      = "Breakout Settings"
string MULTI_GROUP    = "Multi-Indicator Settings"
string RISK_GROUP     = "Risk Management"
string TRAIL_GROUP    = "Trailing Stop Settings"
string FILTER_GROUP   = "Trade Filters"
string SCORING_GROUP  = "Confluence Scoring Weights"

// Strategy selector
strategyChoice = input.string("Multi-Indicator Confluence", title="Active Strategy",
     options=["SMA Crossover (50/200)", "SMA Crossover (20/50)", "RSI (30/70)",
              "RSI (25/75)", "MACD (12/26/9)", "BB + RSI Mean Reversion",
              "Momentum Confluence", "Breakout", "Multi-Indicator Confluence"],
     group=STRAT_GROUP)
enableShorts = input.bool(true, "Enable Put (Short) Entries", group=STRAT_GROUP)

// SMA Crossover
smaShort1  = input.int(50, "Short SMA", minval=1, group=SMA_GROUP)
smaLong1   = input.int(200, "Long SMA", minval=1, group=SMA_GROUP)

// RSI
rsiPeriod  = input.int(14, "RSI Period", minval=1, group=RSI_GROUP)
rsiOS      = input.float(30, "Oversold Threshold", minval=0, maxval=100, group=RSI_GROUP)
rsiOB      = input.float(70, "Overbought Threshold", minval=0, maxval=100, group=RSI_GROUP)

// MACD
macdFast   = input.int(12, "Fast EMA", minval=1, group=MACD_GROUP)
macdSlow   = input.int(26, "Slow EMA", minval=1, group=MACD_GROUP)
macdSignal = input.int(9, "Signal Period", minval=1, group=MACD_GROUP)

// BB + RSI Mean Reversion
bbPeriod   = input.int(20, "BB Period", minval=1, group=BB_RSI_GROUP)
bbMult     = input.float(2.0, "BB Std Dev Multiplier", minval=0.1, step=0.1, group=BB_RSI_GROUP)
bbAdxThresh = input.float(25.0, "ADX Range-Bound Threshold", minval=1, group=BB_RSI_GROUP)

// Momentum Confluence
momEmaFilt = input.int(200, "Trend Filter EMA", minval=1, group=MOM_GROUP)
momAdxStr  = input.float(25.0, "ADX Strong Trend Threshold", minval=1, group=MOM_GROUP)
momAdxWeak = input.float(20.0, "ADX Weak Trend Threshold", minval=1, group=MOM_GROUP)

// Breakout
brkSqzLookback = input.int(120, "Squeeze Lookback", minval=10, group=BRK_GROUP)
brkVolMult     = input.float(1.5, "Volume Multiplier", minval=1.0, step=0.1, group=BRK_GROUP)

// Multi-Indicator Confluence
multiBuyThreshPct  = input.float(50.0, "Buy Threshold (%)", minval=10, maxval=100, step=5, group=MULTI_GROUP)
multiSellThreshPct = input.float(50.0, "Sell Threshold (%)", minval=10, maxval=100, step=5, group=MULTI_GROUP)

// Risk Management
atrPeriod       = input.int(14, "ATR Period", minval=1, group=RISK_GROUP)
slMultiplier    = input.float(1.5, "Stop-Loss ATR Multiplier", minval=0.5, step=0.1, group=RISK_GROUP)
tpMultiplier    = input.float(3.0, "Take-Profit ATR Multiplier", minval=1.0, step=0.1, group=RISK_GROUP)
riskPerTrade    = input.float(2.0, "Risk Per Trade (%)", minval=0.5, maxval=10, step=0.5, group=RISK_GROUP)

// Trailing Stop
useTrailingStop = input.bool(true, "Enable Trailing Stop", group=TRAIL_GROUP)
trailATRMult    = input.float(2.0, "Trailing Stop ATR Multiplier", minval=0.5, step=0.1, group=TRAIL_GROUP)
trailActivation = input.float(1.5, "Trailing Activation ATR Mult", minval=0.5, step=0.1, group=TRAIL_GROUP)

// Trade Filters
useTrendFilter  = input.bool(true, "Require EMA200 Trend Alignment", group=FILTER_GROUP)
useVolFilter    = input.bool(true, "Require Volume Confirmation", group=FILTER_GROUP)
volFilterMult   = input.float(0.8, "Min Volume / 20-bar Avg", minval=0.1, step=0.1, group=FILTER_GROUP)
cooldownBars    = input.int(3, "Cooldown Bars After Exit", minval=0, maxval=50, group=FILTER_GROUP)

// Confluence Scoring Weights (for Multi-Indicator strategy)
wTrendEma     = input.float(1.5, "EMA 12/26 Trend Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wTrendSma200  = input.float(2.0, "SMA 200 Trend Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wTrendIchi    = input.float(1.0, "Ichimoku Cloud Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wMomRsi       = input.float(1.0, "RSI Recovery Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wMomMacd      = input.float(1.5, "MACD Crossover Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wMomStoch     = input.float(0.5, "Stochastic Crossover Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wVolObv       = input.float(1.0, "OBV Trend Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)
wVolMfi       = input.float(0.5, "MFI Recovery Weight", minval=0, maxval=5, step=0.5, group=SCORING_GROUP)

// ---------------------------------------------------------------------------
// TECHNICAL INDICATORS
// ---------------------------------------------------------------------------

// Moving Averages
sma20   = ta.sma(close, 20)
sma50   = ta.sma(close, 50)
sma200  = ta.sma(close, 200)
ema12   = ta.ema(close, 12)
ema26   = ta.ema(close, 26)
ema200  = ta.ema(close, 200)

// Configurable SMA Crossover pairs
smaShortVal = ta.sma(close, smaShort1)
smaLongVal  = ta.sma(close, smaLong1)

// RSI
rsiVal     = ta.rsi(close, rsiPeriod)
prevRSI    = rsiVal[1]

// MACD
[macdLine, macdSig, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)

// Bollinger Bands
bbBasis  = ta.sma(close, bbPeriod)
bbDev    = ta.stdev(close, bbPeriod) * bbMult
bbUpper  = bbBasis + bbDev
bbLower  = bbBasis - bbDev
bbWidth  = bbBasis != 0 ? (bbUpper - bbLower) / bbBasis : 0
bbPctB   = (bbUpper - bbLower) != 0 ? (close - bbLower) / (bbUpper - bbLower) : 0.5

// Stochastic Oscillator
stochK_raw = ta.stoch(close, high, low, 14)
stochK     = ta.sma(stochK_raw, 3)
stochD     = ta.sma(stochK, 3)

// ADX / DI
adxLen = 14
[diPlus, diMinus, adxVal] = ta.dmi(adxLen, adxLen)

// ATR
atrVal = ta.atr(atrPeriod)

// OBV
obvVal    = ta.obv
obvSmaF   = ta.sma(obvVal, 5)
obvRising = obvSmaF > obvSmaF[1]

// MFI
mfiVal = ta.mfi(hlc3, 14)

// Volume Average
avgVol20 = ta.sma(volume, 20)

// Parabolic SAR
sarVal     = ta.sar(0.02, 0.02, 0.2)
sarBullish = close > sarVal

// Ichimoku
tenkan = (ta.highest(high, 9) + ta.lowest(low, 9)) / 2
kijun  = (ta.highest(high, 26) + ta.lowest(low, 26)) / 2
spanA  = (tenkan + kijun) / 2
spanB  = (ta.highest(high, 52) + ta.lowest(low, 52)) / 2
priceAboveCloud = close > math.max(spanA, spanB)
priceBelowCloud = close < math.min(spanA, spanB)

// ---------------------------------------------------------------------------
// STRATEGY 1 & 2: SMA CROSSOVER
// ---------------------------------------------------------------------------

smaBuy  = ta.crossover(smaShortVal, smaLongVal)
smaSell = ta.crossunder(smaShortVal, smaLongVal)

// ---------------------------------------------------------------------------
// STRATEGY 3 & 4: RSI
// ---------------------------------------------------------------------------

rsiBuy  = ta.crossover(rsiVal, rsiOS)
rsiSell = ta.crossunder(rsiVal, rsiOB)

// ---------------------------------------------------------------------------
// STRATEGY 5: MACD
// ---------------------------------------------------------------------------

macdBuy  = ta.crossover(macdLine, macdSig)
macdSell = ta.crossunder(macdLine, macdSig)

// ---------------------------------------------------------------------------
// STRATEGY 6: BB + RSI MEAN REVERSION
// ---------------------------------------------------------------------------

bbIsRangeBound = adxVal < bbAdxThresh

bbPriceAtLower = close <= bbLower or (close[1] < bbLower and close >= bbLower)
bbRsiRecovery  = rsiVal > rsiOS and prevRSI <= rsiOS
bbStochOS      = stochK < 20

bbPriceAtUpper = close >= bbUpper or (close[1] > bbUpper and close <= bbUpper)
bbRsiTopping   = rsiVal < rsiOB and prevRSI >= rsiOB
bbStochOB      = stochK > 80

bbRsiBuy  = bbIsRangeBound and (bbPriceAtLower or bbRsiRecovery) and bbStochOS
bbRsiSell = bbIsRangeBound and (bbPriceAtUpper or bbRsiTopping) and bbStochOB

// ---------------------------------------------------------------------------
// STRATEGY 7: MOMENTUM CONFLUENCE (MACD + ADX + EMA)
// ---------------------------------------------------------------------------

momEma          = ta.ema(close, momEmaFilt)
momMacdBullX    = ta.crossover(macdLine, macdSig)
momMacdBearX    = ta.crossunder(macdLine, macdSig)
momStrongTrend  = adxVal > momAdxStr
momWeakTrend    = adxVal < momAdxWeak
momBullishDI    = diPlus > diMinus
momBearishDI    = diMinus > diPlus
momAboveEma     = close > momEma
momBelowEma     = close < momEma
momObvConfirm   = obvRising

momBuy  = momMacdBullX and momStrongTrend and momBullishDI and momAboveEma and momObvConfirm
momSell = momMacdBearX and momStrongTrend and momBearishDI and momBelowEma

// ---------------------------------------------------------------------------
// STRATEGY 8: BREAKOUT (BB Squeeze + Volume + ATR)
// ---------------------------------------------------------------------------

bbWidthMin    = ta.lowest(bbWidth, brkSqzLookback)
isSqueeze     = bbWidth <= bbWidthMin * 1.10
highVolume    = volume > avgVol20 * brkVolMult
atrExpanding  = atrVal > atrVal[1]

bullishBreakout  = close > bbUpper and close[1] <= bbUpper[1]
bearishBreakdown = close < bbLower and close[1] >= bbLower[1]
failedBreakout   = close[1] > bbUpper[1] and close < bbBasis

brkBuy  = (isSqueeze or atrExpanding) and bullishBreakout and highVolume
brkSell = (isSqueeze or atrExpanding) and bearishBreakdown and highVolume

// ---------------------------------------------------------------------------
// STRATEGY 9: MULTI-INDICATOR CONFLUENCE (WEIGHTED)
// ---------------------------------------------------------------------------

// --- Weighted Buy Score ---
float wBuyScore = 0.0
float wBuyMax   = 0.0

// Trend: EMA(12) > EMA(26)
wBuyScore += ema12 > ema26 ? wTrendEma : 0.0
wBuyMax   += wTrendEma

// Trend: Price > SMA(200)
wBuyScore += (sma200 > 0 and close > sma200) ? wTrendSma200 : 0.0
wBuyMax   += wTrendSma200

// Trend: Ichimoku price above cloud
wBuyScore += priceAboveCloud ? wTrendIchi : 0.0
wBuyMax   += wTrendIchi

// Momentum: RSI oversold recovery
wBuyScore += (rsiVal > 30 and prevRSI <= 30) ? wMomRsi : 0.0
wBuyMax   += wMomRsi

// Momentum: MACD bullish crossover
wBuyScore += (macdLine > macdSig and macdLine[1] <= macdSig[1]) ? wMomMacd : 0.0
wBuyMax   += wMomMacd

// Momentum: Stochastic crossover from oversold
wBuyScore += (stochK < 30 and stochK > stochD and stochK[1] <= stochD[1]) ? wMomStoch : 0.0
wBuyMax   += wMomStoch

// Volume: OBV rising
wBuyScore += obvRising ? wVolObv : 0.0
wBuyMax   += wVolObv

// Volume: MFI oversold recovery
wBuyScore += (mfiVal < 30 and mfiVal > mfiVal[1]) ? wVolMfi : 0.0
wBuyMax   += wVolMfi

float wBuyPct = wBuyMax > 0 ? (wBuyScore / wBuyMax) * 100 : 0.0

// --- Weighted Sell Score ---
float wSellScore = 0.0
float wSellMax   = 0.0

// Trend: EMA(12) < EMA(26)
wSellScore += ema12 < ema26 ? wTrendEma : 0.0
wSellMax   += wTrendEma

// Trend: Price < SMA(200)
wSellScore += (sma200 > 0 and close < sma200) ? wTrendSma200 : 0.0
wSellMax   += wTrendSma200

// Trend: Ichimoku price below cloud
wSellScore += priceBelowCloud ? wTrendIchi : 0.0
wSellMax   += wTrendIchi

// Momentum: RSI overbought pullback
wSellScore += (rsiVal < 70 and prevRSI >= 70) ? wMomRsi : 0.0
wSellMax   += wMomRsi

// Momentum: MACD bearish crossover
wSellScore += (macdLine < macdSig and macdLine[1] >= macdSig[1]) ? wMomMacd : 0.0
wSellMax   += wMomMacd

// Momentum: Stochastic crossover from overbought
wSellScore += (stochK > 70 and stochK < stochD and stochK[1] >= stochD[1]) ? wMomStoch : 0.0
wSellMax   += wMomStoch

// Volume: OBV falling
wSellScore += not obvRising ? wVolObv : 0.0
wSellMax   += wVolObv

// Volume: MFI overbought declining
wSellScore += (mfiVal > 70 and mfiVal < mfiVal[1]) ? wVolMfi : 0.0
wSellMax   += wVolMfi

float wSellPct = wSellMax > 0 ? (wSellScore / wSellMax) * 100 : 0.0

multiBuy  = wBuyPct >= multiBuyThreshPct and wBuyPct > wSellPct
multiSell = wSellPct >= multiSellThreshPct and wSellPct > wBuyPct

// ---------------------------------------------------------------------------
// STRATEGY ROUTER
// ---------------------------------------------------------------------------

bool isBuy  = false
bool isSell = false

switch strategyChoice
    "SMA Crossover (50/200)" =>
        isBuy  := smaBuy
        isSell := smaSell
    "SMA Crossover (20/50)" =>
        isBuy  := smaBuy
        isSell := smaSell
    "RSI (30/70)" =>
        isBuy  := rsiBuy
        isSell := rsiSell
    "RSI (25/75)" =>
        isBuy  := rsiBuy
        isSell := rsiSell
    "MACD (12/26/9)" =>
        isBuy  := macdBuy
        isSell := macdSell
    "BB + RSI Mean Reversion" =>
        isBuy  := bbRsiBuy
        isSell := bbRsiSell
    "Momentum Confluence" =>
        isBuy  := momBuy
        isSell := momSell
    "Breakout" =>
        isBuy  := brkBuy
        isSell := brkSell
    "Multi-Indicator Confluence" =>
        isBuy  := multiBuy
        isSell := multiSell

// ---------------------------------------------------------------------------
// TRADE FILTERS
// ---------------------------------------------------------------------------

// Trend alignment: only calls above EMA200, puts below EMA200
bool trendAllowsLong  = not useTrendFilter or (close > ema200)
bool trendAllowsShort = not useTrendFilter or (close < ema200)

// Volume confirmation: require at least average volume
bool volumeConfirmed = not useVolFilter or (avgVol20 > 0 and volume >= avgVol20 * volFilterMult)

// Cooldown: prevent whipsaws after exit
var int barsSinceExit = 100
if strategy.position_size == 0 and strategy.position_size[1] != 0
    barsSinceExit := 0
else
    barsSinceExit += 1
bool cooldownClear = barsSinceExit >= cooldownBars

// ---------------------------------------------------------------------------
// FILTERED ENTRY SIGNALS
// ---------------------------------------------------------------------------

bool callEntry = isBuy  and trendAllowsLong  and volumeConfirmed and cooldownClear
bool putEntry  = isSell and trendAllowsShort and volumeConfirmed and cooldownClear and enableShorts

// ---------------------------------------------------------------------------
// POSITION SIZING (risk-based)
// ---------------------------------------------------------------------------

float stopDistance = atrVal * slMultiplier
float riskAmount  = strategy.equity * (riskPerTrade / 100.0)
float posSize     = stopDistance > 0 ? riskAmount / stopDistance : na

// ---------------------------------------------------------------------------
// STOP-LOSS & TAKE-PROFIT TRACKING
// ---------------------------------------------------------------------------

var float entryPrice  = na
var float stopLevel   = na
var float targetLevel = na
var float trailStop   = na
var float entryATR    = na

// Detect new long entry
if strategy.position_size > 0 and strategy.position_size[1] <= 0
    entryPrice  := strategy.opentrades.entry_price(strategy.opentrades - 1)
    entryATR    := atrVal
    stopLevel   := entryPrice - atrVal * slMultiplier
    targetLevel := entryPrice + atrVal * tpMultiplier
    trailStop   := na

// Detect new short entry
if strategy.position_size < 0 and strategy.position_size[1] >= 0
    entryPrice  := strategy.opentrades.entry_price(strategy.opentrades - 1)
    entryATR    := atrVal
    stopLevel   := entryPrice + atrVal * slMultiplier
    targetLevel := entryPrice - atrVal * tpMultiplier
    trailStop   := na

// ---------------------------------------------------------------------------
// TRAILING STOP MANAGEMENT
// ---------------------------------------------------------------------------

if useTrailingStop and strategy.position_size > 0 and not na(entryPrice) and not na(entryATR)
    float moveFromEntry = close - entryPrice
    float activationDist = entryATR * trailActivation
    if moveFromEntry >= activationDist
        float candidateTrail = close - atrVal * trailATRMult
        if na(trailStop) or candidateTrail > trailStop
            trailStop := candidateTrail
        if not na(trailStop) and trailStop > stopLevel
            stopLevel := trailStop

if useTrailingStop and strategy.position_size < 0 and not na(entryPrice) and not na(entryATR)
    float moveFromEntry = entryPrice - close
    float activationDist = entryATR * trailActivation
    if moveFromEntry >= activationDist
        float candidateTrail = close + atrVal * trailATRMult
        if na(trailStop) or candidateTrail < trailStop
            trailStop := candidateTrail
        if not na(trailStop) and trailStop < stopLevel
            stopLevel := trailStop

// ---------------------------------------------------------------------------
// STRATEGY EXECUTION -- CALL (Long) & PUT (Short)
// ---------------------------------------------------------------------------

// --- CALL ENTRY ---
if callEntry and strategy.position_size == 0
    strategy.entry("Call Entry", strategy.long, qty=posSize)
    alert("CALL ENTRY: " + syminfo.tickerid + " @ " + str.tostring(close, "#.##") +
          " | Stop: " + str.tostring(close - stopDistance, "#.##") +
          " | Target: " + str.tostring(close + atrVal * tpMultiplier, "#.##"),
          alert.freq_once_per_bar)

// --- PUT ENTRY ---
if putEntry and strategy.position_size == 0
    strategy.entry("Put Entry", strategy.short, qty=posSize)
    alert("PUT ENTRY: " + syminfo.tickerid + " @ " + str.tostring(close, "#.##") +
          " | Stop: " + str.tostring(close + stopDistance, "#.##") +
          " | Target: " + str.tostring(close - atrVal * tpMultiplier, "#.##"),
          alert.freq_once_per_bar)

// --- CALL EXIT (signal-based) ---
if strategy.position_size > 0 and isSell
    strategy.close("Call Entry", comment="Call Signal Exit")
    alert("CALL EXIT (Signal): " + syminfo.tickerid + " @ " + str.tostring(close, "#.##"),
          alert.freq_once_per_bar)

// --- PUT EXIT (signal-based) ---
if strategy.position_size < 0 and isBuy
    strategy.close("Put Entry", comment="Put Signal Exit")
    alert("PUT EXIT (Signal): " + syminfo.tickerid + " @ " + str.tostring(close, "#.##"),
          alert.freq_once_per_bar)

// --- ATR-based stop-loss and take-profit exits ---
if strategy.position_size > 0 and not na(stopLevel) and not na(targetLevel)
    strategy.exit("Call SL/TP", "Call Entry",
         stop=stopLevel, limit=targetLevel,
         comment_loss="Call Stop Loss", comment_profit="Call Take Profit")

if strategy.position_size < 0 and not na(stopLevel) and not na(targetLevel)
    strategy.exit("Put SL/TP", "Put Entry",
         stop=stopLevel, limit=targetLevel,
         comment_loss="Put Stop Loss", comment_profit="Put Take Profit")

// ---------------------------------------------------------------------------
// MINIMAL VISUALS (strategy tester only)
// ---------------------------------------------------------------------------

// Entry/exit markers
plotshape(callEntry and strategy.position_size[1] <= 0, title="Call Entry",
     location=location.belowbar, style=shape.triangleup,
     size=size.small, color=color.new(color.green, 0), text="CALL")
plotshape(putEntry and strategy.position_size[1] >= 0, title="Put Entry",
     location=location.abovebar, style=shape.triangledown,
     size=size.small, color=color.new(color.red, 0), text="PUT")

// Stop-loss and take-profit levels
plot(strategy.position_size > 0 and not na(stopLevel) ? stopLevel : na,
     "Long Stop", color=color.new(color.red, 30), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size > 0 and not na(targetLevel) ? targetLevel : na,
     "Long Target", color=color.new(color.green, 30), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 and not na(stopLevel) ? stopLevel : na,
     "Short Stop", color=color.new(color.red, 30), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 and not na(targetLevel) ? targetLevel : na,
     "Short Target", color=color.new(color.green, 30), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size != 0 and not na(trailStop) ? trailStop : na,
     "Trail Stop", color=color.new(color.orange, 30), style=plot.style_linebr, linewidth=1)
